{% extends "layout/layout_app.html" %}
{% block title %}Pesan - Amica{% endblock %}

{% block content %}
<div x-data="chatApp()" class="relative h-[calc(100vh-5rem)] md:p-6 overflow-hidden">

    <!-- MAIN CONTAINER -->
    <div class="bg-white dark:bg-cardDark md:rounded-[2.5rem] shadow-sm h-full flex overflow-hidden border-none relative">

        <!-- 1. SIDEBAR: CHAT LIST -->
        <div class="w-full md:w-80 flex flex-col border-r border-gray-50 dark:border-white/5 bg-white dark:bg-cardDark z-20 absolute inset-0 md:relative"
             :class="activeChat ? 'hidden md:flex' : 'flex'">
            
            <!-- Header Sidebar (Search + New Chat Button) -->
            <div class="p-6 pb-2 shrink-0">
                <h1 class="text-2xl font-extrabold text-gray-900 dark:text-white mb-4 tracking-tight">Pesan</h1>
                
                <!-- Search -->
                <div class="relative group mb-4">
                    <input type="text" x-model="searchQuery" placeholder="Cari obrolan..." 
                           class="w-full pl-10 pr-4 py-3 rounded-2xl bg-gray-50 dark:bg-darkBg border-none text-sm focus:ring-2 focus:ring-primary placeholder-gray-400 transition-all">
                    <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>

                <!-- NEW: Liquid Glass Button (Mulai Chat) -->
                <button @click="isConnectionModalOpen = true" 
                        class="w-full flex items-center justify-center gap-2 py-3 rounded-2xl bg-blue-50 dark:bg-primary/10 text-primary hover:bg-blue-100 dark:hover:bg-primary/20 transition-all group font-bold text-sm mb-2 border border-blue-100 dark:border-white/5">
                    <svg class="w-5 h-5 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    <span>Mulai Percakapan Baru</span>
                </button>
            </div>

            <!-- List Chat -->
            <div class="flex-1 overflow-y-auto custom-scrollbar px-4 pb-4 space-y-1">
                <template x-for="chat in filteredChats" :key="chat.id">
                    <button @click="selectChat(chat)" 
                            class="w-full flex items-center gap-4 p-3 rounded-2xl transition-all duration-200 group"
                            :class="activeChat && activeChat.id === chat.id ? 'bg-blue-50 dark:bg-white/10' : 'hover:bg-gray-50 dark:hover:bg-white/5'">
                        
                        <div class="relative shrink-0">
                            <img :src="chat.avatar" class="w-12 h-12 rounded-full object-cover ring-2 ring-transparent group-hover:ring-gray-200 dark:group-hover:ring-gray-700 transition-all">
                            <span x-show="chat.online" class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white dark:border-cardDark rounded-full"></span>
                        </div>
                        
                        <div class="flex-1 min-w-0 text-left">
                            <div class="flex justify-between items-baseline mb-0.5">
                                <h3 class="text-sm font-bold text-gray-900 dark:text-white truncate" x-text="chat.name"></h3>
                                <span class="text-[10px] text-gray-400" x-text="chat.time"></span>
                            </div>
                            <p class="text-xs truncate" 
                               :class="chat.unread ? 'font-bold text-gray-800 dark:text-gray-200' : 'text-gray-500 dark:text-gray-400'" 
                               x-text="chat.lastMessage"></p>
                        </div>

                        <div x-show="chat.unread > 0" class="w-5 h-5 rounded-full bg-primary text-white text-[10px] font-bold flex items-center justify-center shadow-lg shadow-blue-500/30">
                            <span x-text="chat.unread"></span>
                        </div>
                    </button>
                </template>
            </div>
        </div>

        <!-- 2. CHAT AREA -->
        <div class="flex-1 flex flex-col bg-[#F8FAFC] dark:bg-[#0B0F19]/50 md:relative absolute inset-0 z-30 transition-transform duration-300"
             :class="activeChat ? 'translate-x-0' : 'translate-x-full md:translate-x-0'">
            
            <!-- Empty State -->
            <div x-show="!activeChat" class="hidden md:flex flex-col items-center justify-center h-full text-center p-10">
                <div class="w-24 h-24 bg-blue-50 dark:bg-white/5 rounded-full flex items-center justify-center mb-6">
                    <svg class="w-10 h-10 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                </div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Mulai Percakapan</h3>
                <p class="text-gray-500 max-w-xs">Pilih teman atau klik tombol di sidebar untuk memulai obrolan baru.</p>
            </div>

            <!-- Active Chat -->
            <div x-show="activeChat" class="flex flex-col h-full w-full" x-cloak>
                
                <!-- Chat Header -->
                <div class="h-20 px-6 flex items-center justify-between bg-white dark:bg-cardDark border-b border-gray-50 dark:border-white/5 shrink-0">
                    <div class="flex items-center gap-4">
                        <button @click="activeChat = null" class="md:hidden p-2 -ml-2 text-gray-500 hover:text-gray-900 dark:hover:text-white">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        
                        <img :src="activeChat?.avatar" class="w-10 h-10 rounded-full object-cover ring-2 ring-gray-100 dark:ring-white/10">
                        <div>
                            <h3 class="text-base font-bold text-gray-900 dark:text-white" x-text="activeChat?.name"></h3>
                            <p class="text-xs text-green-500 font-medium" x-show="activeChat?.online">Sedang online</p>
                        </div>
                    </div>
                    <!-- Option Menu -->
                    <button class="p-2 rounded-full hover:bg-gray-50 dark:hover:bg-white/5 text-gray-400 hover:text-primary transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path></svg>
                    </button>
                </div>

                <!-- Messages -->
                <div class="flex-1 overflow-y-auto custom-scrollbar p-4 md:p-6 space-y-6" id="messagesContainer">
                    <template x-for="msg in currentMessages" :key="msg.id">
                        <div class="flex w-full" :class="msg.isMe ? 'justify-end' : 'justify-start'">
                            <div class="max-w-[75%] md:max-w-[60%]">
                                <div class="p-4 rounded-2xl shadow-sm text-sm leading-relaxed"
                                     :class="msg.isMe 
                                        ? 'bg-primary text-white rounded-tr-sm' 
                                        : 'bg-white dark:bg-cardDark text-gray-800 dark:text-gray-200 rounded-tl-sm'">
                                    <p x-text="msg.text"></p>
                                </div>
                                <p class="text-[10px] text-gray-400 mt-1" 
                                   :class="msg.isMe ? 'text-right' : 'text-left'" 
                                   x-text="msg.time"></p>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Input Area (Text Only - Sesuai DB) -->
                <div class="p-4 bg-white dark:bg-cardDark border-t border-gray-50 dark:border-white/5 shrink-0">
                    <form @submit.prevent="sendMessage" class="flex items-end gap-3">
                        <div class="flex-1 bg-gray-50 dark:bg-darkBg rounded-2xl px-4 py-2 focus-within:ring-2 focus-within:ring-primary/20 transition-shadow">
                            <textarea x-model="newMessage" @keydown.enter.prevent="sendMessage" rows="1" class="w-full bg-transparent border-none focus:ring-0 text-sm resize-none max-h-24 pt-2.5 text-gray-900 dark:text-white placeholder-gray-400" placeholder="Tulis pesan..."></textarea>
                        </div>

                        <button type="submit" :disabled="!newMessage.trim()" class="p-3 rounded-full bg-primary text-white shadow-lg shadow-blue-500/30 hover:bg-blue-600 transition disabled:opacity-50 disabled:shadow-none transform hover:scale-105 active:scale-95">
                            <svg class="w-5 h-5 rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                        </button>
                    </form>
                </div>

            </div>
        </div>

    </div>

    <!-- MODAL KONEKSI (Sama seperti sebelumnya, hanya ganti trigger button di atas) -->
    <div x-show="isConnectionModalOpen" x-cloak class="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div @click.away="isConnectionModalOpen = false" 
             class="bg-white dark:bg-cardDark w-full max-w-md rounded-3xl shadow-2xl overflow-hidden ring-1 ring-gray-200 dark:ring-white/10 flex flex-col max-h-[80vh]">
            
            <div class="px-6 py-5 border-b border-gray-100 dark:border-white/5 flex justify-between items-center">
                <h2 class="text-lg font-bold text-gray-900 dark:text-white">Pesan Baru</h2>
                <button @click="isConnectionModalOpen = false" class="text-gray-400 hover:text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>

            <div class="p-4 pb-2">
                <div class="relative group">
                    <input type="text" x-model="searchConnection" placeholder="Cari koneksi..." 
                           class="w-full pl-10 pr-4 py-2.5 rounded-xl bg-gray-50 dark:bg-darkBg border-none text-sm focus:ring-2 focus:ring-primary placeholder-gray-400">
                    <svg class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-1">
                <template x-for="conn in filteredConnections" :key="conn.id">
                    <button @click="startNewChat(conn)" class="w-full flex items-center gap-4 p-3 rounded-xl hover:bg-gray-50 dark:hover:bg-white/5 transition text-left group">
                        <img :src="conn.avatar" class="w-10 h-10 rounded-full object-cover ring-2 ring-gray-100 dark:ring-white/10">
                        <div class="flex-1 min-w-0">
                            <h4 class="text-sm font-bold text-gray-900 dark:text-white truncate" x-text="conn.name"></h4>
                            <p class="text-xs text-gray-500 truncate" x-text="'@' + conn.username"></p>
                        </div>
                        <svg class="w-5 h-5 text-gray-300 group-hover:text-primary transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                    </button>
                </template>
                <div x-show="filteredConnections.length === 0" class="text-center py-8 text-gray-400 text-sm">
                    Tidak ada koneksi ditemukan.
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    function chatApp() {
        return {
            searchQuery: '',
            searchConnection: '',
            activeChat: null,
            newMessage: '',
            isConnectionModalOpen: false,
            
            // Dummy Data
            chats: [
                { id: 1, name: 'Dr. Anisa, Sp.A', username: 'anisa_spa', avatar: 'https://i.pravatar.cc/150?img=31', lastMessage: 'Sama-sama, semoga membantu ya!', time: '10:05', unread: 0, online: true },
                { id: 2, name: 'Rahma', username: 'rahma_mom', avatar: 'https://i.pravatar.cc/150?img=5', lastMessage: 'Iya, nanti aku coba resepnya.', time: '09:30', unread: 2, online: false },
            ],
            connections: [
                { id: 3, name: 'Ayah Keren', username: 'ayah_keren', avatar: 'https://i.pravatar.cc/150?img=32' },
                { id: 4, name: 'Bunda Ceria', username: 'bunda_ceria', avatar: 'https://i.pravatar.cc/150?img=9' },
                { id: 1, name: 'Dr. Anisa, Sp.A', username: 'anisa_spa', avatar: 'https://i.pravatar.cc/150?img=31' },
                { id: 5, name: 'Keluarga Cemara', username: 'cemara_fam', avatar: 'https://i.pravatar.cc/150?img=12' }
            ],
            messagesDb: {
                1: [
                    { id: 1, text: 'Halo Dok, mau tanya soal MPASI anak saya.', isMe: true, time: '09:55' },
                    { id: 2, text: 'Halo Bunda, boleh silakan. Apa kendalanya?', isMe: false, time: '09:58' },
                    { id: 3, text: 'Anak saya agak susah makan sayur akhir-akhir ini.', isMe: true, time: '10:00' },
                    { id: 4, text: 'Coba variasi tekstur atau sembunyikan dalam olahan nuget bun.', isMe: false, time: '10:02' },
                    { id: 5, text: 'Terima kasih banyak atas sarannya, Dok.', isMe: true, time: '10:04' },
                    { id: 6, text: 'Sama-sama, semoga membantu ya!', isMe: false, time: '10:05' }
                ]
            },
            currentMessages: [],

            get filteredChats() { return this.chats.filter(c => c.name.toLowerCase().includes(this.searchQuery.toLowerCase())); },
            get filteredConnections() { return this.connections.filter(c => c.name.toLowerCase().includes(this.searchConnection.toLowerCase())); },

            selectChat(chat) {
                this.activeChat = chat;
                this.currentMessages = this.messagesDb[chat.id] || [];
                chat.unread = 0;
                this.$nextTick(() => this.scrollToBottom());
            },

            startNewChat(conn) {
                let existingChat = this.chats.find(c => c.id === conn.id);
                if (!existingChat) {
                    const newChatEntry = {
                        id: conn.id, name: conn.name, username: conn.username, avatar: conn.avatar,
                        lastMessage: 'Ketuk untuk mulai chat', time: 'Baru', unread: 0, online: false
                    };
                    this.chats.unshift(newChatEntry);
                    existingChat = newChatEntry;
                }
                this.isConnectionModalOpen = false;
                this.selectChat(existingChat);
            },

            sendMessage() {
                if (!this.newMessage.trim()) return;
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                if (!this.messagesDb[this.activeChat.id]) this.messagesDb[this.activeChat.id] = [];
                const newMsg = { id: Date.now(), text: this.newMessage, isMe: true, time: time };
                this.messagesDb[this.activeChat.id].push(newMsg);
                this.currentMessages.push(newMsg);
                this.activeChat.lastMessage = this.newMessage;
                this.activeChat.time = time;
                
                const index = this.chats.indexOf(this.activeChat);
                if (index > 0) { this.chats.splice(index, 1); this.chats.unshift(this.activeChat); }
                
                this.newMessage = '';
                this.$nextTick(() => this.scrollToBottom());
            },

            scrollToBottom() {
                const container = document.getElementById('messagesContainer');
                if (container) container.scrollTop = container.scrollHeight;
            }
        }
    }
</script>
{% endblock %}